// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`log_range_aggregation 1 1`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 300000,
    "matrix": true,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    Array [
      "labels",
      "asc",
    ],
    Array [
      "timestamp_ms",
      "asc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    "labels",
    Array [
      Raw {
        "raw": "floor(timestamp_ms / undefined) * undefined",
      },
      "timestamp_ms",
    ],
    Array [
      Raw {
        "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
      },
      "value",
    ],
  ],
  "tables": Array [
    Array [
      Term {
        "term": "rate_b",
      },
    ],
  ],
  "withs": Object {
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "aut illo",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 300000,
          "matrix": true,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'minus_nam')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'minus_nam')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "aut illo",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_read",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            Raw {
              "raw": "JSONExtractKeysAndValues(labels, 'String')",
            },
            "labels",
          ],
          Array [
            Raw {
              "raw": "floor(timestamp_ms / 300000) * 300000",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": Array [],
                  "conditions": Conjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "",
                          "toString": [Function],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONExtractString(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": "aut illo",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    ],
                  },
                  "ctx": Object {
                    "duration": 300000,
                    "matrix": true,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": Array [],
                  },
                  "joins": Array [
                    Object {
                      "conditions": Array [
                        Condition {
                          "column": Term {
                            "term": "samples.fingerprint",
                          },
                          "operator": "=",
                          "value": Term {
                            "term": "time_series.fingerprint",
                          },
                        },
                      ],
                      "table": Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'minus_nam')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONExtractString(labels, 'minus_nam')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "aut illo",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": "loki.time_series",
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                        "time_series",
                      ],
                      "type": "left",
                    },
                  ],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": Array [
                    Array [
                      "timestamp_ms",
                      "desc",
                    ],
                    Array [
                      "labels",
                      "desc",
                    ],
                  ],
                  "params": Object {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_read",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": Array [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": Array [
                    Array [
                      "time_series.labels",
                      "labels",
                    ],
                    Array [
                      "samples.string",
                      "string",
                    ],
                    Array [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    Array [
                      "samples.timestamp_ms",
                      "timestamp_ms",
                    ],
                  ],
                  "tables": Array [
                    Array [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_read",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": Object {},
                },
              },
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'minus_nam')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'minus_nam')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "aut illo",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 1 2`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'minus_nam') = 1) and (JSONExtractString(labels, 'minus_nam') = 'aut illo'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 300000) * 300000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select \`labels\`,floor(timestamp_ms / undefined) * undefined as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc"`;

exports[`log_range_aggregation 2 1`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 300000,
    "matrix": true,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    Array [
      "labels",
      "asc",
    ],
    Array [
      "timestamp_ms",
      "asc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    "labels",
    Array [
      Raw {
        "raw": "floor(timestamp_ms / undefined) * undefined",
      },
      "timestamp_ms",
    ],
    Array [
      Raw {
        "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
      },
      "value",
    ],
  ],
  "tables": Array [
    Array [
      Term {
        "term": "rate_b",
      },
    ],
  ],
  "withs": Object {
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'rerum_laborum')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                      },
                                      "operator": "!=",
                                      "value": Value {
                                        "value": "[]",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            Condition {
              "column": Raw {
                "raw": "position(string, 'consequatur nam soluta')",
              },
              "operator": "=",
              "value": Value {
                "value": 0,
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 300000,
          "matrix": true,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                },
                                "operator": "!=",
                                "value": Value {
                                  "value": "[]",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_read",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            Raw {
              "raw": "JSONExtractKeysAndValues(labels, 'String')",
            },
            "labels",
          ],
          Array [
            Raw {
              "raw": "floor(timestamp_ms / 300000) * 300000",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": Array [],
                  "conditions": Conjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "",
                          "toString": [Function],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                                },
                                                "operator": "!=",
                                                "value": Value {
                                                  "value": "[]",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "position(string, 'consequatur nam soluta')",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 0,
                        },
                      },
                    ],
                  },
                  "ctx": Object {
                    "duration": 300000,
                    "matrix": true,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": Array [],
                  },
                  "joins": Array [
                    Object {
                      "conditions": Array [
                        Condition {
                          "column": Term {
                            "term": "samples.fingerprint",
                          },
                          "operator": "=",
                          "value": Term {
                            "term": "time_series.fingerprint",
                          },
                        },
                      ],
                      "table": Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'rerum_laborum')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                          },
                                          "operator": "!=",
                                          "value": Value {
                                            "value": "[]",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": "loki.time_series",
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                        "time_series",
                      ],
                      "type": "left",
                    },
                  ],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": Array [
                    Array [
                      "timestamp_ms",
                      "desc",
                    ],
                    Array [
                      "labels",
                      "desc",
                    ],
                  ],
                  "params": Object {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_read",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": Array [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": Array [
                    Array [
                      "time_series.labels",
                      "labels",
                    ],
                    Array [
                      "samples.string",
                      "string",
                    ],
                    Array [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    Array [
                      "samples.timestamp_ms",
                      "timestamp_ms",
                    ],
                  ],
                  "tables": Array [
                    Array [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_read",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": Object {},
                },
              },
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'rerum_laborum')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": "[]",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 2 2`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'rerum_laborum') = 1) and (extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)') != '[]'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (position(string, 'consequatur nam soluta') = 0) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 300000) * 300000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select \`labels\`,floor(timestamp_ms / undefined) * undefined as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc"`;

exports[`log_range_aggregation 3 1`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 300000,
    "matrix": true,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    Array [
      "labels",
      "asc",
    ],
    Array [
      "timestamp_ms",
      "asc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    "labels",
    Array [
      Raw {
        "raw": "floor(timestamp_ms / undefined) * undefined",
      },
      "timestamp_ms",
    ],
    Array [
      Raw {
        "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
      },
      "value",
    ],
  ],
  "tables": Array [
    Array [
      Term {
        "term": "rate_b",
      },
    ],
  ],
  "withs": Object {
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'et_dolorem')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'et_dolorem')",
                                      },
                                      "operator": "!=",
                                      "value": Value {
                                        "value": "nemo doloremque",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            Condition {
              "column": Raw {
                "raw": "extractAllGroups(string, '(^mol[eE][^ ]+e +voluptatibus)')",
              },
              "operator": "!=",
              "value": Raw {
                "raw": "[]",
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 300000,
          "matrix": true,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'et_dolorem')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'et_dolorem')",
                                },
                                "operator": "!=",
                                "value": Value {
                                  "value": "nemo doloremque",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_read",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            Raw {
              "raw": "JSONExtractKeysAndValues(labels, 'String')",
            },
            "labels",
          ],
          Array [
            Raw {
              "raw": "floor(timestamp_ms / 300000) * 300000",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": Array [],
                  "conditions": Conjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "",
                          "toString": [Function],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'et_dolorem')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONExtractString(labels, 'et_dolorem')",
                                                },
                                                "operator": "!=",
                                                "value": Value {
                                                  "value": "nemo doloremque",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "extractAllGroups(string, '(^mol[eE][^ ]+e +voluptatibus)')",
                        },
                        "operator": "!=",
                        "value": Raw {
                          "raw": "[]",
                        },
                      },
                    ],
                  },
                  "ctx": Object {
                    "duration": 300000,
                    "matrix": true,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": Array [],
                  },
                  "joins": Array [
                    Object {
                      "conditions": Array [
                        Condition {
                          "column": Term {
                            "term": "samples.fingerprint",
                          },
                          "operator": "=",
                          "value": Term {
                            "term": "time_series.fingerprint",
                          },
                        },
                      ],
                      "table": Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'et_dolorem')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONExtractString(labels, 'et_dolorem')",
                                          },
                                          "operator": "!=",
                                          "value": Value {
                                            "value": "nemo doloremque",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": "loki.time_series",
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                        "time_series",
                      ],
                      "type": "left",
                    },
                  ],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": Array [
                    Array [
                      "timestamp_ms",
                      "desc",
                    ],
                    Array [
                      "labels",
                      "desc",
                    ],
                  ],
                  "params": Object {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_read",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": Array [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": Array [
                    Array [
                      "time_series.labels",
                      "labels",
                    ],
                    Array [
                      "samples.string",
                      "string",
                    ],
                    Array [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    Array [
                      "samples.timestamp_ms",
                      "timestamp_ms",
                    ],
                  ],
                  "tables": Array [
                    Array [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_read",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": Object {},
                },
              },
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'et_dolorem')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'et_dolorem')",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": "nemo doloremque",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 3 2`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'et_dolorem') = 1) and (JSONExtractString(labels, 'et_dolorem') != 'nemo doloremque'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (extractAllGroups(string, '(^mol[eE][^ ]+e +voluptatibus)') != []) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 300000) * 300000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select \`labels\`,floor(timestamp_ms / undefined) * undefined as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc"`;

exports[`log_range_aggregation 4 1`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 300000,
    "matrix": true,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    Array [
      "labels",
      "asc",
    ],
    Array [
      "timestamp_ms",
      "asc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    "labels",
    Array [
      Raw {
        "raw": "floor(timestamp_ms / undefined) * undefined",
      },
      "timestamp_ms",
    ],
    Array [
      Raw {
        "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
      },
      "value",
    ],
  ],
  "tables": Array [
    Array [
      Term {
        "term": "rate_b",
      },
    ],
  ],
  "withs": Object {
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'rerum_laborum')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "[]",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            Condition {
              "column": Raw {
                "raw": "extractAllGroups(string, '(cons[eE][^ ]+r nam soluta)')",
              },
              "operator": "=",
              "value": Raw {
                "raw": "[]",
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 300000,
          "matrix": true,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "[]",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_read",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            Raw {
              "raw": "JSONExtractKeysAndValues(labels, 'String')",
            },
            "labels",
          ],
          Array [
            Raw {
              "raw": "floor(timestamp_ms / 300000) * 300000",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": Array [],
                  "conditions": Conjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "",
                          "toString": [Function],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": "[]",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "extractAllGroups(string, '(cons[eE][^ ]+r nam soluta)')",
                        },
                        "operator": "=",
                        "value": Raw {
                          "raw": "[]",
                        },
                      },
                    ],
                  },
                  "ctx": Object {
                    "duration": 300000,
                    "matrix": true,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": Array [],
                  },
                  "joins": Array [
                    Object {
                      "conditions": Array [
                        Condition {
                          "column": Term {
                            "term": "samples.fingerprint",
                          },
                          "operator": "=",
                          "value": Term {
                            "term": "time_series.fingerprint",
                          },
                        },
                      ],
                      "table": Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'rerum_laborum')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "[]",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": "loki.time_series",
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                        "time_series",
                      ],
                      "type": "left",
                    },
                  ],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": Array [
                    Array [
                      "timestamp_ms",
                      "desc",
                    ],
                    Array [
                      "labels",
                      "desc",
                    ],
                  ],
                  "params": Object {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_read",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": Array [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": Array [
                    Array [
                      "time_series.labels",
                      "labels",
                    ],
                    Array [
                      "samples.string",
                      "string",
                    ],
                    Array [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    Array [
                      "samples.timestamp_ms",
                      "timestamp_ms",
                    ],
                  ],
                  "tables": Array [
                    Array [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_read",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": Object {},
                },
              },
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'rerum_laborum')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "[]",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`log_range_aggregation 4 2`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'rerum_laborum') = 1) and (extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)') = '[]'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (extractAllGroups(string, '(cons[eE][^ ]+r nam soluta)') = []) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 300000) * 300000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select \`labels\`,floor(timestamp_ms / undefined) * undefined as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc"`;

exports[`shoud transpile unwrap 1`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 60000,
    "matrix": true,
    "step": 120000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Term {
          "term": "timestamp_ms",
        },
        "operator": "!=",
        "value": Value {
          "value": 0,
        },
      },
    ],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    "labels",
    "timestamp_ms",
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 2000,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": null,
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": null,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      Raw {
        "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['fmt']) != 0, JSONExtractKeysAndValues(labels, 'String')))",
      },
      "labels",
    ],
    Array [
      Raw {
        "raw": "SUM(unwrapped) / 60",
      },
      "value",
    ],
    Array [
      Raw {
        "raw": "intDiv(intDiv(timestamp_ms, 60000) * 60000, 120000) * 120000",
      },
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      WithReference {
        "ref": With {
          "alias": "uw_rate_a",
          "inline": undefined,
          "query": Select {
            "aggregations": Array [],
            "conditions": Conjunction {
              "args": Array [
                Condition {
                  "column": Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                In {
                  "column": Term {
                    "term": "samples.fingerprint",
                  },
                  "operator": "in",
                  "value": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [],
                    },
                    "ctx": Object {},
                    "dist": false,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                    ],
                    "tables": Array [
                      Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'test_id')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONExtractString(labels, 'test_id')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "0.7857680014573265_json",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": null,
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
                Condition {
                  "column": Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'int_lbl')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  "operator": "=",
                  "value": Condition {
                    "column": Raw {
                      "raw": "isNotNull(unwrapped)",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                },
                Condition {
                  "column": Raw {
                    "raw": "intDiv(timestamp_ms, 60000) * 60000 % 120000",
                  },
                  "operator": "<",
                  "value": Value {
                    "value": 60000,
                  },
                },
              ],
            },
            "ctx": Object {
              "duration": 60000,
              "matrix": true,
              "step": 120000,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": Array [],
            },
            "joins": Array [
              Object {
                "conditions": Array [
                  Condition {
                    "column": Term {
                      "term": "samples.fingerprint",
                    },
                    "operator": "=",
                    "value": Term {
                      "term": "time_series.fingerprint",
                    },
                  },
                ],
                "table": Array [
                  WithReference {
                    "ref": With {
                      "alias": "str_sel",
                      "inline": undefined,
                      "query": Select {
                        "aggregations": Array [],
                        "conditions": Conjunction {
                          "args": Array [
                            Condition {
                              "column": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Raw {
                                      "raw": "JSONHas(labels, 'test_id')",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": 1,
                                    },
                                  },
                                  Condition {
                                    "column": Raw {
                                      "raw": "JSONExtractString(labels, 'test_id')",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "0.7857680014573265_json",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": Object {},
                        "dist": true,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": Array [],
                        },
                        "joins": Array [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": Array [],
                        "params": Object {},
                        "preconditions": Conjunction {
                          "args": Array [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": Array [
                          "fingerprint",
                          "labels",
                        ],
                        "tables": Array [
                          Array [
                            Parameter {
                              "name": "timeSeriesTable",
                              "value": null,
                            },
                          ],
                        ],
                        "withs": Object {},
                      },
                    },
                  },
                  "time_series",
                ],
                "type": "left",
              },
            ],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": Array [
              Array [
                "timestamp_ms",
                "desc",
              ],
              Array [
                "labels",
                "desc",
              ],
            ],
            "params": Object {
              "from": Parameter {
                "name": "from",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 2000,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": null,
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": null,
              },
            },
            "preconditions": Conjunction {
              "args": Array [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": Array [
              Array [
                "time_series.labels",
                "labels",
              ],
              Array [
                "samples.string",
                "string",
              ],
              Array [
                "samples.fingerprint",
                "fingerprint",
              ],
              Array [
                "samples.timestamp_ms",
                "timestamp_ms",
              ],
              Array [
                Raw {
                  "raw": "toFloat64OrNull(JSONExtractString(labels,'int_lbl'))",
                },
              ],
            ],
            "tables": Array [
              Array [
                Parameter {
                  "name": "samplesTable",
                  "value": null,
                },
                Term {
                  "term": "samples",
                },
              ],
            ],
            "withs": Object {},
          },
        },
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'test_id')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'test_id')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "0.7857680014573265_json",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": null,
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "uw_rate_a": With {
      "alias": "uw_rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'test_id')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'test_id')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "0.7857680014573265_json",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": null,
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            Condition {
              "column": Condition {
                "column": Raw {
                  "raw": "JSONHas(labels, 'int_lbl')",
                },
                "operator": "=",
                "value": Value {
                  "value": 1,
                },
              },
              "operator": "=",
              "value": Condition {
                "column": Raw {
                  "raw": "isNotNull(unwrapped)",
                },
                "operator": "=",
                "value": Value {
                  "value": 1,
                },
              },
            },
            Condition {
              "column": Raw {
                "raw": "intDiv(timestamp_ms, 60000) * 60000 % 120000",
              },
              "operator": "<",
              "value": Value {
                "value": 60000,
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 60000,
          "matrix": true,
          "step": 120000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'test_id')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'test_id')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "0.7857680014573265_json",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": null,
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 2000,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": null,
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": null,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64OrNull(JSONExtractString(labels,'int_lbl'))",
            },
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": null,
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`shoud transpile unwrap 2`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 60000,
    "matrix": true,
    "step": 120000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Term {
          "term": "timestamp_ms",
        },
        "operator": "!=",
        "value": Value {
          "value": 0,
        },
      },
    ],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    "labels",
    "timestamp_ms",
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 2000,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": null,
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": null,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      Raw {
        "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['fmt']) != 0, arraySort(arrayConcat(arrayFilter(x -> arrayExists(y -> y.1 == x.1, extra_labels) == 0, JSONExtractKeysAndValues(labels, 'String')), extra_labels))))",
      },
      "labels",
    ],
    Array [
      Raw {
        "raw": "SUM(unwrapped) / 60",
      },
      "value",
    ],
    Array [
      Raw {
        "raw": "intDiv(intDiv(timestamp_ms, 60000) * 60000, 120000) * 120000",
      },
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      WithReference {
        "ref": With {
          "alias": "uw_rate_a",
          "inline": undefined,
          "query": Select {
            "aggregations": Array [],
            "conditions": Conjunction {
              "args": Array [
                Condition {
                  "column": Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                In {
                  "column": Term {
                    "term": "samples.fingerprint",
                  },
                  "operator": "in",
                  "value": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [],
                    },
                    "ctx": Object {},
                    "dist": false,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                    ],
                    "tables": Array [
                      Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'test_id')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONExtractString(labels, 'test_id')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "0.7857680014573265_json",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": null,
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
                Condition {
                  "column": Raw {
                    "raw": "isValidJSON(samples.string)",
                  },
                  "operator": "=",
                  "value": Value {
                    "value": 1,
                  },
                },
                Condition {
                  "column": Disjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl2', extra_labels)",
                        },
                        "operator": "!=",
                        "value": Value {
                          "value": 0,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "JSONHas(labels, 'int_lbl2')",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 1,
                        },
                      },
                    ],
                  },
                  "operator": "=",
                  "value": Condition {
                    "column": Raw {
                      "raw": "isNotNull(unwrapped)",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                },
                Condition {
                  "column": Raw {
                    "raw": "intDiv(timestamp_ms, 60000) * 60000 % 120000",
                  },
                  "operator": "<",
                  "value": Value {
                    "value": 60000,
                  },
                },
              ],
            },
            "ctx": Object {
              "duration": 60000,
              "matrix": true,
              "step": 120000,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": Array [],
            },
            "joins": Array [
              Object {
                "conditions": Array [
                  Condition {
                    "column": Term {
                      "term": "samples.fingerprint",
                    },
                    "operator": "=",
                    "value": Term {
                      "term": "time_series.fingerprint",
                    },
                  },
                ],
                "table": Array [
                  WithReference {
                    "ref": With {
                      "alias": "str_sel",
                      "inline": undefined,
                      "query": Select {
                        "aggregations": Array [],
                        "conditions": Conjunction {
                          "args": Array [
                            Condition {
                              "column": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Raw {
                                      "raw": "JSONHas(labels, 'test_id')",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": 1,
                                    },
                                  },
                                  Condition {
                                    "column": Raw {
                                      "raw": "JSONExtractString(labels, 'test_id')",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "0.7857680014573265_json",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": Object {},
                        "dist": true,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": Array [],
                        },
                        "joins": Array [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": Array [],
                        "params": Object {},
                        "preconditions": Conjunction {
                          "args": Array [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": Array [
                          "fingerprint",
                          "labels",
                        ],
                        "tables": Array [
                          Array [
                            Parameter {
                              "name": "timeSeriesTable",
                              "value": null,
                            },
                          ],
                        ],
                        "withs": Object {},
                      },
                    },
                  },
                  "time_series",
                ],
                "type": "left",
              },
            ],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": Array [
              Array [
                "timestamp_ms",
                "desc",
              ],
              Array [
                "labels",
                "desc",
              ],
            ],
            "params": Object {
              "from": Parameter {
                "name": "from",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 2000,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": null,
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": null,
              },
            },
            "preconditions": Conjunction {
              "args": Array [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": Array [
              Array [
                "time_series.labels",
                "labels",
              ],
              Array [
                "samples.string",
                "string",
              ],
              Array [
                "samples.fingerprint",
                "fingerprint",
              ],
              Array [
                "samples.timestamp_ms",
                "timestamp_ms",
              ],
              Array [
                Raw {
                  "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
                },
                "extra_labels",
              ],
              Array [
                Raw {
                  "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl2', extra_labels), arrayFirst(x -> x.1 == 'int_lbl2', extra_labels).2, JSONExtractString(labels,'int_lbl2')))",
                },
                "unwrapped",
              ],
            ],
            "tables": Array [
              Array [
                Parameter {
                  "name": "samplesTable",
                  "value": null,
                },
                Term {
                  "term": "samples",
                },
              ],
            ],
            "withs": Object {},
          },
        },
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'test_id')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'test_id')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "0.7857680014573265_json",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": null,
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "uw_rate_a": With {
      "alias": "uw_rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'test_id')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'test_id')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "0.7857680014573265_json",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": null,
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            Condition {
              "column": Raw {
                "raw": "isValidJSON(samples.string)",
              },
              "operator": "=",
              "value": Value {
                "value": 1,
              },
            },
            Condition {
              "column": Disjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl2', extra_labels)",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": 0,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'int_lbl2')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                ],
              },
              "operator": "=",
              "value": Condition {
                "column": Raw {
                  "raw": "isNotNull(unwrapped)",
                },
                "operator": "=",
                "value": Value {
                  "value": 1,
                },
              },
            },
            Condition {
              "column": Raw {
                "raw": "intDiv(timestamp_ms, 60000) * 60000 % 120000",
              },
              "operator": "<",
              "value": Value {
                "value": 60000,
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 60000,
          "matrix": true,
          "step": 120000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'test_id')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'test_id')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "0.7857680014573265_json",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": null,
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 2000,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": null,
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": null,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
            },
            "extra_labels",
          ],
          Array [
            Raw {
              "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl2', extra_labels), arrayFirst(x -> x.1 == 'int_lbl2', extra_labels).2, JSONExtractString(labels,'int_lbl2')))",
            },
            "unwrapped",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": null,
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`shoud transpile unwrap 3`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 60000,
    "matrix": true,
    "step": 120000,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Term {
          "term": "timestamp_ms",
        },
        "operator": "!=",
        "value": Value {
          "value": 0,
        },
      },
    ],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    "labels",
    "timestamp_ms",
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": null,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 2000,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": null,
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": null,
    },
    "to": Parameter {
      "name": "to",
      "value": null,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      Raw {
        "raw": "arraySort(arrayFilter(x -> arrayExists(y -> x.1 == y, ['int_lbl2']) != 0, arraySort(arrayConcat(arrayFilter(x -> arrayExists(y -> y.1 == x.1, extra_labels) == 0, JSONExtractKeysAndValues(labels, 'String')), extra_labels))))",
      },
      "labels",
    ],
    Array [
      Raw {
        "raw": "SUM(unwrapped) / 60",
      },
      "value",
    ],
    Array [
      Raw {
        "raw": "intDiv(intDiv(timestamp_ms, 60000) * 60000, 120000) * 120000",
      },
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      WithReference {
        "ref": With {
          "alias": "uw_rate_a",
          "inline": undefined,
          "query": Select {
            "aggregations": Array [],
            "conditions": Conjunction {
              "args": Array [
                Condition {
                  "column": Raw {
                    "raw": "",
                    "toString": [Function],
                  },
                  "operator": undefined,
                  "value": Value {
                    "value": undefined,
                  },
                },
                In {
                  "column": Term {
                    "term": "samples.fingerprint",
                  },
                  "operator": "in",
                  "value": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [],
                    },
                    "ctx": Object {},
                    "dist": false,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                    ],
                    "tables": Array [
                      Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'test_id')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONExtractString(labels, 'test_id')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "0.7857680014573265_json",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": null,
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
                Condition {
                  "column": Raw {
                    "raw": "isValidJSON(samples.string)",
                  },
                  "operator": "=",
                  "value": Value {
                    "value": 1,
                  },
                },
                Condition {
                  "column": Disjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl', extra_labels)",
                        },
                        "operator": "!=",
                        "value": Value {
                          "value": 0,
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "JSONHas(labels, 'int_lbl')",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 1,
                        },
                      },
                    ],
                  },
                  "operator": "=",
                  "value": Condition {
                    "column": Raw {
                      "raw": "isNotNull(unwrapped)",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                },
                Condition {
                  "column": Raw {
                    "raw": "intDiv(timestamp_ms, 60000) * 60000 % 120000",
                  },
                  "operator": "<",
                  "value": Value {
                    "value": 60000,
                  },
                },
              ],
            },
            "ctx": Object {
              "duration": 60000,
              "matrix": true,
              "step": 120000,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": Array [],
            },
            "joins": Array [
              Object {
                "conditions": Array [
                  Condition {
                    "column": Term {
                      "term": "samples.fingerprint",
                    },
                    "operator": "=",
                    "value": Term {
                      "term": "time_series.fingerprint",
                    },
                  },
                ],
                "table": Array [
                  WithReference {
                    "ref": With {
                      "alias": "str_sel",
                      "inline": undefined,
                      "query": Select {
                        "aggregations": Array [],
                        "conditions": Conjunction {
                          "args": Array [
                            Condition {
                              "column": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Raw {
                                      "raw": "JSONHas(labels, 'test_id')",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": 1,
                                    },
                                  },
                                  Condition {
                                    "column": Raw {
                                      "raw": "JSONExtractString(labels, 'test_id')",
                                    },
                                    "operator": "=",
                                    "value": Value {
                                      "value": "0.7857680014573265_json",
                                    },
                                  },
                                ],
                              },
                              "operator": undefined,
                              "value": Value {
                                "value": undefined,
                              },
                            },
                          ],
                        },
                        "ctx": Object {},
                        "dist": true,
                        "fmt": undefined,
                        "having_conditions": Conjunction {
                          "args": Array [],
                        },
                        "joins": Array [],
                        "limitbycolumns": undefined,
                        "limits": undefined,
                        "order_expressions": Array [],
                        "params": Object {},
                        "preconditions": Conjunction {
                          "args": Array [],
                        },
                        "request_totals": undefined,
                        "sampling": undefined,
                        "select_list": Array [
                          "fingerprint",
                          "labels",
                        ],
                        "tables": Array [
                          Array [
                            Parameter {
                              "name": "timeSeriesTable",
                              "value": null,
                            },
                          ],
                        ],
                        "withs": Object {},
                      },
                    },
                  },
                  "time_series",
                ],
                "type": "left",
              },
            ],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": Array [
              Array [
                "timestamp_ms",
                "desc",
              ],
              Array [
                "labels",
                "desc",
              ],
            ],
            "params": Object {
              "from": Parameter {
                "name": "from",
                "value": null,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 2000,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": null,
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": null,
              },
              "to": Parameter {
                "name": "to",
                "value": null,
              },
            },
            "preconditions": Conjunction {
              "args": Array [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": Array [
              Array [
                "time_series.labels",
                "labels",
              ],
              Array [
                "samples.string",
                "string",
              ],
              Array [
                "samples.fingerprint",
                "fingerprint",
              ],
              Array [
                "samples.timestamp_ms",
                "timestamp_ms",
              ],
              Array [
                Raw {
                  "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
                },
                "extra_labels",
              ],
              Array [
                Raw {
                  "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl', extra_labels), arrayFirst(x -> x.1 == 'int_lbl', extra_labels).2, JSONExtractString(labels,'int_lbl')))",
                },
                "unwrapped",
              ],
            ],
            "tables": Array [
              Array [
                Parameter {
                  "name": "samplesTable",
                  "value": null,
                },
                Term {
                  "term": "samples",
                },
              ],
            ],
            "withs": Object {},
          },
        },
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'test_id')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'test_id')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "0.7857680014573265_json",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": null,
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "uw_rate_a": With {
      "alias": "uw_rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'test_id')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'test_id')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "0.7857680014573265_json",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": null,
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            Condition {
              "column": Raw {
                "raw": "isValidJSON(samples.string)",
              },
              "operator": "=",
              "value": Value {
                "value": 1,
              },
            },
            Condition {
              "column": Disjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "arrayFirstIndex(x -> x.1 == 'int_lbl', extra_labels)",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": 0,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'int_lbl')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                ],
              },
              "operator": "=",
              "value": Condition {
                "column": Raw {
                  "raw": "isNotNull(unwrapped)",
                },
                "operator": "=",
                "value": Value {
                  "value": 1,
                },
              },
            },
            Condition {
              "column": Raw {
                "raw": "intDiv(timestamp_ms, 60000) * 60000 % 120000",
              },
              "operator": "<",
              "value": Value {
                "value": 60000,
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 60000,
          "matrix": true,
          "step": 120000,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'test_id')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'test_id')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "0.7857680014573265_json",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": null,
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": null,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 2000,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": null,
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": null,
          },
          "to": Parameter {
            "name": "to",
            "value": null,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "arrayFilter((x) -> x.2 != '', [('int_lbl2', if(JSONType(samples.string, 'int_val') == 'String', JSONExtractString(samples.string, 'int_val'), JSONExtractRaw(samples.string, 'int_val')))])",
            },
            "extra_labels",
          ],
          Array [
            Raw {
              "raw": "toFloat64OrNull(if(arrayExists(x -> x.1 == 'int_lbl', extra_labels), arrayFirst(x -> x.1 == 'int_lbl', extra_labels).2, JSONExtractString(labels,'int_lbl')))",
            },
            "unwrapped",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": null,
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 1`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 300000,
    "end": 3600000,
    "matrix": true,
    "start": 0,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    "labels",
    "timestamp_ms",
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      Raw {
        "raw": "arrayFilter(x -> x.1 IN ('label_1'), labels)",
      },
      "labels",
    ],
    "timestamp_ms",
    Array [
      Raw {
        "raw": "sum(value)",
      },
      "value",
    ],
  ],
  "tables": Array [
    Array [
      WithReference {
        "ref": With {
          "alias": "agg_a",
          "inline": undefined,
          "query": Select {
            "aggregations": Array [
              "labels",
              "timestamp_ms",
            ],
            "conditions": Conjunction {
              "args": Array [],
            },
            "ctx": Object {
              "duration": 300000,
              "end": 3600000,
              "matrix": true,
              "start": 0,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": Array [],
            },
            "joins": Array [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": Array [
              Array [
                "labels",
                "asc",
              ],
              Array [
                "timestamp_ms",
                "asc",
              ],
            ],
            "params": Object {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_read",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": Array [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": Array [
              "labels",
              Array [
                Raw {
                  "raw": "floor(timestamp_ms / undefined) * undefined",
                },
                "timestamp_ms",
              ],
              Array [
                Raw {
                  "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
                },
                "value",
              ],
            ],
            "tables": Array [
              Array [
                Term {
                  "term": "rate_b",
                },
              ],
            ],
            "withs": Object {},
          },
        },
      },
    ],
  ],
  "withs": Object {
    "agg_a": With {
      "alias": "agg_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {
          "duration": 300000,
          "end": 3600000,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "labels",
          Array [
            Raw {
              "raw": "floor(timestamp_ms / undefined) * undefined",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            Term {
              "term": "rate_b",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "aut illo",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 300000,
          "end": 3600000,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'minus_nam')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'minus_nam')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "aut illo",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_read",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            Raw {
              "raw": "JSONExtractKeysAndValues(labels, 'String')",
            },
            "labels",
          ],
          Array [
            Raw {
              "raw": "floor(timestamp_ms / 300000) * 300000",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": Array [],
                  "conditions": Conjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "",
                          "toString": [Function],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONExtractString(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": "aut illo",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    ],
                  },
                  "ctx": Object {
                    "duration": 300000,
                    "end": 3600000,
                    "matrix": true,
                    "start": 0,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": Array [],
                  },
                  "joins": Array [
                    Object {
                      "conditions": Array [
                        Condition {
                          "column": Term {
                            "term": "samples.fingerprint",
                          },
                          "operator": "=",
                          "value": Term {
                            "term": "time_series.fingerprint",
                          },
                        },
                      ],
                      "table": Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'minus_nam')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONExtractString(labels, 'minus_nam')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "aut illo",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": "loki.time_series",
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                        "time_series",
                      ],
                      "type": "left",
                    },
                  ],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": Array [
                    Array [
                      "timestamp_ms",
                      "desc",
                    ],
                    Array [
                      "labels",
                      "desc",
                    ],
                  ],
                  "params": Object {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_read",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": Array [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": Array [
                    Array [
                      "time_series.labels",
                      "labels",
                    ],
                    Array [
                      "samples.string",
                      "string",
                    ],
                    Array [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    Array [
                      "samples.timestamp_ms",
                      "timestamp_ms",
                    ],
                  ],
                  "tables": Array [
                    Array [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_read",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": Object {},
                },
              },
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'minus_nam')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'minus_nam')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "aut illo",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 2`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'minus_nam') = 1) and (JSONExtractString(labels, 'minus_nam') = 'aut illo'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 300000) * 300000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc), agg_a AS (select \`labels\`,floor(timestamp_ms / undefined) * undefined as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select arrayFilter(x -> x.1 IN ('label_1'), labels) as \`labels\`,\`timestamp_ms\`,sum(value) as \`value\` from agg_a group by \`labels\`,\`timestamp_ms\` order by \`labels\`,\`timestamp_ms\`"`;

exports[`should transpile aggregation_operator 3`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 300000,
    "end": 3600000,
    "matrix": true,
    "start": 0,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    "labels",
    "timestamp_ms",
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      Raw {
        "raw": "arrayFilter(x -> x.1 IN ('label_1'), labels)",
      },
      "labels",
    ],
    "timestamp_ms",
    Array [
      Raw {
        "raw": "sum(value)",
      },
      "value",
    ],
  ],
  "tables": Array [
    Array [
      WithReference {
        "ref": With {
          "alias": "agg_a",
          "inline": undefined,
          "query": Select {
            "aggregations": Array [
              "labels",
              "timestamp_ms",
            ],
            "conditions": Conjunction {
              "args": Array [],
            },
            "ctx": Object {
              "duration": 300000,
              "end": 3600000,
              "matrix": true,
              "start": 0,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": Array [],
            },
            "joins": Array [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": Array [
              Array [
                "labels",
                "asc",
              ],
              Array [
                "timestamp_ms",
                "asc",
              ],
            ],
            "params": Object {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_read",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": Array [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": Array [
              "labels",
              Array [
                Raw {
                  "raw": "floor(timestamp_ms / undefined) * undefined",
                },
                "timestamp_ms",
              ],
              Array [
                Raw {
                  "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
                },
                "value",
              ],
            ],
            "tables": Array [
              Array [
                Term {
                  "term": "rate_b",
                },
              ],
            ],
            "withs": Object {},
          },
        },
      },
    ],
  ],
  "withs": Object {
    "agg_a": With {
      "alias": "agg_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {
          "duration": 300000,
          "end": 3600000,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "labels",
          Array [
            Raw {
              "raw": "floor(timestamp_ms / undefined) * undefined",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            Term {
              "term": "rate_b",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "fmt": undefined,
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "aut illo",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'rerum_laborum')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                      },
                                      "operator": "!=",
                                      "value": Value {
                                        "value": "[]",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
            Condition {
              "column": Raw {
                "raw": "position(string, 'consequatur nam soluta')",
              },
              "operator": "=",
              "value": Value {
                "value": 0,
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 300000,
          "end": 3600000,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                },
                                "operator": "!=",
                                "value": Value {
                                  "value": "[]",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_read",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            Raw {
              "raw": "JSONExtractKeysAndValues(labels, 'String')",
            },
            "labels",
          ],
          Array [
            Raw {
              "raw": "floor(timestamp_ms / 300000) * 300000",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": Array [],
                  "conditions": Conjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "",
                          "toString": [Function],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "fmt": undefined,
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONExtractString(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": "aut illo",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                                },
                                                "operator": "!=",
                                                "value": Value {
                                                  "value": "[]",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                      Condition {
                        "column": Raw {
                          "raw": "position(string, 'consequatur nam soluta')",
                        },
                        "operator": "=",
                        "value": Value {
                          "value": 0,
                        },
                      },
                    ],
                  },
                  "ctx": Object {
                    "duration": 300000,
                    "end": 3600000,
                    "matrix": true,
                    "start": 0,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": Array [],
                  },
                  "joins": Array [
                    Object {
                      "conditions": Array [
                        Condition {
                          "column": Term {
                            "term": "samples.fingerprint",
                          },
                          "operator": "=",
                          "value": Term {
                            "term": "time_series.fingerprint",
                          },
                        },
                      ],
                      "table": Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'rerum_laborum')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                          },
                                          "operator": "!=",
                                          "value": Value {
                                            "value": "[]",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": "loki.time_series",
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                        "time_series",
                      ],
                      "type": "left",
                    },
                  ],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": Array [
                    Array [
                      "timestamp_ms",
                      "desc",
                    ],
                    Array [
                      "labels",
                      "desc",
                    ],
                  ],
                  "params": Object {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_read",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": Array [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": Array [
                    Array [
                      "time_series.labels",
                      "labels",
                    ],
                    Array [
                      "samples.string",
                      "string",
                    ],
                    Array [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    Array [
                      "samples.timestamp_ms",
                      "timestamp_ms",
                    ],
                  ],
                  "tables": Array [
                    Array [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_read",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": Object {},
                },
              },
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'rerum_laborum')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": "[]",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 4`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'rerum_laborum') = 1) and (extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)') != '[]'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (position(string, 'consequatur nam soluta') = 0) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 300000) * 300000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc), agg_a AS (select \`labels\`,floor(timestamp_ms / undefined) * undefined as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select arrayFilter(x -> x.1 IN ('label_1'), labels) as \`labels\`,\`timestamp_ms\`,sum(value) as \`value\` from agg_a group by \`labels\`,\`timestamp_ms\` order by \`labels\`,\`timestamp_ms\`"`;

exports[`should transpile aggregation_operator 5`] = `
Select {
  "aggregations": Array [
    "labels",
    "timestamp_ms",
  ],
  "conditions": Conjunction {
    "args": Array [],
  },
  "ctx": Object {
    "duration": 300000,
    "end": 3600000,
    "matrix": true,
    "start": 0,
  },
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [],
  "limitbycolumns": undefined,
  "limits": undefined,
  "order_expressions": Array [
    "labels",
    "timestamp_ms",
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      Raw {
        "raw": "arrayFilter(x -> x.1 IN ('label_1'), labels)",
      },
      "labels",
    ],
    "timestamp_ms",
    Array [
      Raw {
        "raw": "sum(value)",
      },
      "value",
    ],
  ],
  "tables": Array [
    Array [
      WithReference {
        "ref": With {
          "alias": "agg_a",
          "inline": undefined,
          "query": Select {
            "aggregations": Array [
              "labels",
              "timestamp_ms",
            ],
            "conditions": Conjunction {
              "args": Array [],
            },
            "ctx": Object {
              "duration": 300000,
              "end": 3600000,
              "matrix": true,
              "start": 0,
            },
            "dist": false,
            "fmt": undefined,
            "having_conditions": Conjunction {
              "args": Array [],
            },
            "joins": Array [],
            "limitbycolumns": undefined,
            "limits": undefined,
            "order_expressions": Array [
              Array [
                "labels",
                "asc",
              ],
              Array [
                "timestamp_ms",
                "asc",
              ],
            ],
            "params": Object {
              "from": Parameter {
                "name": "from",
                "value": 1,
              },
              "limit": Parameter {
                "name": "limit",
                "value": 3,
              },
              "samplesTable": Parameter {
                "name": "samplesTable",
                "value": "loki.samples_read",
              },
              "timeSeriesTable": Parameter {
                "name": "timeSeriesTable",
                "value": "loki.time_series",
              },
              "to": Parameter {
                "name": "to",
                "value": 2,
              },
            },
            "preconditions": Conjunction {
              "args": Array [],
            },
            "request_totals": undefined,
            "sampling": undefined,
            "select_list": Array [
              "labels",
              Array [
                Raw {
                  "raw": "floor(timestamp_ms / undefined) * undefined",
                },
                "timestamp_ms",
              ],
              Array [
                Raw {
                  "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
                },
                "value",
              ],
            ],
            "tables": Array [
              Array [
                Term {
                  "term": "rate_b",
                },
              ],
            ],
            "withs": Object {},
          },
        },
      },
    ],
  ],
  "withs": Object {
    "agg_a": With {
      "alias": "agg_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {
          "duration": 300000,
          "end": 3600000,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "labels",
          Array [
            Raw {
              "raw": "floor(timestamp_ms / undefined) * undefined",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "argMin(rate_b.value, rate_b.timestamp_ms)",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            Term {
              "term": "rate_b",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_a": With {
      "alias": "rate_a",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Raw {
                "raw": "",
                "toString": [Function],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            In {
              "column": Term {
                "term": "samples.fingerprint",
              },
              "operator": "in",
              "value": Select {
                "aggregations": Array [],
                "conditions": Conjunction {
                  "args": Array [],
                },
                "ctx": Object {},
                "dist": false,
                "fmt": undefined,
                "having_conditions": Conjunction {
                  "args": Array [],
                },
                "joins": Array [],
                "limitbycolumns": undefined,
                "limits": undefined,
                "order_expressions": Array [],
                "params": Object {},
                "preconditions": Conjunction {
                  "args": Array [],
                },
                "request_totals": undefined,
                "sampling": undefined,
                "select_list": Array [
                  "fingerprint",
                ],
                "tables": Array [
                  Array [
                    WithReference {
                      "ref": With {
                        "alias": "str_sel",
                        "inline": undefined,
                        "query": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Conjunction {
                                  "args": Array [
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONHas(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": 1,
                                      },
                                    },
                                    Condition {
                                      "column": Raw {
                                        "raw": "JSONExtractString(labels, 'minus_nam')",
                                      },
                                      "operator": "=",
                                      "value": Value {
                                        "value": "aut illo",
                                      },
                                    },
                                  ],
                                },
                                "operator": undefined,
                                "value": Value {
                                  "value": undefined,
                                },
                              },
                            ],
                          },
                          "ctx": Object {},
                          "dist": true,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                            "labels",
                          ],
                          "tables": Array [
                            Array [
                              Parameter {
                                "name": "timeSeriesTable",
                                "value": "loki.time_series",
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    },
                  ],
                ],
                "withs": Object {},
              },
            },
          ],
        },
        "ctx": Object {
          "duration": 300000,
          "end": 3600000,
          "matrix": true,
          "start": 0,
        },
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [
          Object {
            "conditions": Array [
              Condition {
                "column": Term {
                  "term": "samples.fingerprint",
                },
                "operator": "=",
                "value": Term {
                  "term": "time_series.fingerprint",
                },
              },
            ],
            "table": Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'minus_nam')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'minus_nam')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "aut illo",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
              "time_series",
            ],
            "type": "left",
          },
        ],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "timestamp_ms",
            "desc",
          ],
          Array [
            "labels",
            "desc",
          ],
        ],
        "params": Object {
          "from": Parameter {
            "name": "from",
            "value": 1,
          },
          "limit": Parameter {
            "name": "limit",
            "value": 3,
          },
          "samplesTable": Parameter {
            "name": "samplesTable",
            "value": "loki.samples_read",
          },
          "timeSeriesTable": Parameter {
            "name": "timeSeriesTable",
            "value": "loki.time_series",
          },
          "to": Parameter {
            "name": "to",
            "value": 2,
          },
        },
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            "time_series.labels",
            "labels",
          ],
          Array [
            "samples.string",
            "string",
          ],
          Array [
            "samples.fingerprint",
            "fingerprint",
          ],
          Array [
            "samples.timestamp_ms",
            "timestamp_ms",
          ],
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "samplesTable",
              "value": "loki.samples_read",
            },
            Term {
              "term": "samples",
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "rate_b": With {
      "alias": "rate_b",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [
          "labels",
          "timestamp_ms",
        ],
        "conditions": Conjunction {
          "args": Array [],
        },
        "ctx": Object {},
        "dist": false,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [
          Array [
            "labels",
            "asc",
          ],
          Array [
            "timestamp_ms",
            "asc",
          ],
        ],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          Array [
            Raw {
              "raw": "JSONExtractKeysAndValues(labels, 'String')",
            },
            "labels",
          ],
          Array [
            Raw {
              "raw": "floor(timestamp_ms / 300000) * 300000",
            },
            "timestamp_ms",
          ],
          Array [
            Raw {
              "raw": "toFloat64(count(1)) * 1000 / 300000",
            },
            "value",
          ],
        ],
        "tables": Array [
          Array [
            WithReference {
              "ref": With {
                "alias": "rate_a",
                "inline": undefined,
                "query": Select {
                  "aggregations": Array [],
                  "conditions": Conjunction {
                    "args": Array [
                      Condition {
                        "column": Raw {
                          "raw": "",
                          "toString": [Function],
                        },
                        "operator": undefined,
                        "value": Value {
                          "value": undefined,
                        },
                      },
                      In {
                        "column": Term {
                          "term": "samples.fingerprint",
                        },
                        "operator": "in",
                        "value": Select {
                          "aggregations": Array [],
                          "conditions": Conjunction {
                            "args": Array [],
                          },
                          "ctx": Object {},
                          "dist": false,
                          "fmt": undefined,
                          "having_conditions": Conjunction {
                            "args": Array [],
                          },
                          "joins": Array [],
                          "limitbycolumns": undefined,
                          "limits": undefined,
                          "order_expressions": Array [],
                          "params": Object {},
                          "preconditions": Conjunction {
                            "args": Array [],
                          },
                          "request_totals": undefined,
                          "sampling": undefined,
                          "select_list": Array [
                            "fingerprint",
                          ],
                          "tables": Array [
                            Array [
                              WithReference {
                                "ref": With {
                                  "alias": "str_sel",
                                  "inline": undefined,
                                  "query": Select {
                                    "aggregations": Array [],
                                    "conditions": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Conjunction {
                                            "args": Array [
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONHas(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": 1,
                                                },
                                              },
                                              Condition {
                                                "column": Raw {
                                                  "raw": "JSONExtractString(labels, 'minus_nam')",
                                                },
                                                "operator": "=",
                                                "value": Value {
                                                  "value": "aut illo",
                                                },
                                              },
                                            ],
                                          },
                                          "operator": undefined,
                                          "value": Value {
                                            "value": undefined,
                                          },
                                        },
                                      ],
                                    },
                                    "ctx": Object {},
                                    "dist": true,
                                    "fmt": undefined,
                                    "having_conditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "joins": Array [],
                                    "limitbycolumns": undefined,
                                    "limits": undefined,
                                    "order_expressions": Array [],
                                    "params": Object {},
                                    "preconditions": Conjunction {
                                      "args": Array [],
                                    },
                                    "request_totals": undefined,
                                    "sampling": undefined,
                                    "select_list": Array [
                                      "fingerprint",
                                      "labels",
                                    ],
                                    "tables": Array [
                                      Array [
                                        Parameter {
                                          "name": "timeSeriesTable",
                                          "value": "loki.time_series",
                                        },
                                      ],
                                    ],
                                    "withs": Object {},
                                  },
                                },
                              },
                            ],
                          ],
                          "withs": Object {},
                        },
                      },
                    ],
                  },
                  "ctx": Object {
                    "duration": 300000,
                    "end": 3600000,
                    "matrix": true,
                    "start": 0,
                  },
                  "dist": false,
                  "fmt": undefined,
                  "having_conditions": Conjunction {
                    "args": Array [],
                  },
                  "joins": Array [
                    Object {
                      "conditions": Array [
                        Condition {
                          "column": Term {
                            "term": "samples.fingerprint",
                          },
                          "operator": "=",
                          "value": Term {
                            "term": "time_series.fingerprint",
                          },
                        },
                      ],
                      "table": Array [
                        WithReference {
                          "ref": With {
                            "alias": "str_sel",
                            "inline": undefined,
                            "query": Select {
                              "aggregations": Array [],
                              "conditions": Conjunction {
                                "args": Array [
                                  Condition {
                                    "column": Conjunction {
                                      "args": Array [
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONHas(labels, 'minus_nam')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": 1,
                                          },
                                        },
                                        Condition {
                                          "column": Raw {
                                            "raw": "JSONExtractString(labels, 'minus_nam')",
                                          },
                                          "operator": "=",
                                          "value": Value {
                                            "value": "aut illo",
                                          },
                                        },
                                      ],
                                    },
                                    "operator": undefined,
                                    "value": Value {
                                      "value": undefined,
                                    },
                                  },
                                ],
                              },
                              "ctx": Object {},
                              "dist": true,
                              "fmt": undefined,
                              "having_conditions": Conjunction {
                                "args": Array [],
                              },
                              "joins": Array [],
                              "limitbycolumns": undefined,
                              "limits": undefined,
                              "order_expressions": Array [],
                              "params": Object {},
                              "preconditions": Conjunction {
                                "args": Array [],
                              },
                              "request_totals": undefined,
                              "sampling": undefined,
                              "select_list": Array [
                                "fingerprint",
                                "labels",
                              ],
                              "tables": Array [
                                Array [
                                  Parameter {
                                    "name": "timeSeriesTable",
                                    "value": "loki.time_series",
                                  },
                                ],
                              ],
                              "withs": Object {},
                            },
                          },
                        },
                        "time_series",
                      ],
                      "type": "left",
                    },
                  ],
                  "limitbycolumns": undefined,
                  "limits": undefined,
                  "order_expressions": Array [
                    Array [
                      "timestamp_ms",
                      "desc",
                    ],
                    Array [
                      "labels",
                      "desc",
                    ],
                  ],
                  "params": Object {
                    "from": Parameter {
                      "name": "from",
                      "value": 1,
                    },
                    "limit": Parameter {
                      "name": "limit",
                      "value": 3,
                    },
                    "samplesTable": Parameter {
                      "name": "samplesTable",
                      "value": "loki.samples_read",
                    },
                    "timeSeriesTable": Parameter {
                      "name": "timeSeriesTable",
                      "value": "loki.time_series",
                    },
                    "to": Parameter {
                      "name": "to",
                      "value": 2,
                    },
                  },
                  "preconditions": Conjunction {
                    "args": Array [],
                  },
                  "request_totals": undefined,
                  "sampling": undefined,
                  "select_list": Array [
                    Array [
                      "time_series.labels",
                      "labels",
                    ],
                    Array [
                      "samples.string",
                      "string",
                    ],
                    Array [
                      "samples.fingerprint",
                      "fingerprint",
                    ],
                    Array [
                      "samples.timestamp_ms",
                      "timestamp_ms",
                    ],
                  ],
                  "tables": Array [
                    Array [
                      Parameter {
                        "name": "samplesTable",
                        "value": "loki.samples_read",
                      },
                      Term {
                        "term": "samples",
                      },
                    ],
                  ],
                  "withs": Object {},
                },
              },
            },
          ],
        ],
        "withs": Object {},
      },
    },
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'minus_nam')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'minus_nam')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "aut illo",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile aggregation_operator 6`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'minus_nam') = 1) and (JSONExtractString(labels, 'minus_nam') = 'aut illo'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 300000) * 300000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 300000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc), agg_a AS (select \`labels\`,floor(timestamp_ms / undefined) * undefined as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select arrayFilter(x -> x.1 IN ('label_1'), labels) as \`labels\`,\`timestamp_ms\`,sum(value) as \`value\` from agg_a group by \`labels\`,\`timestamp_ms\` order by \`labels\`,\`timestamp_ms\`"`;

exports[`should transpile complex pipelines 1`] = `
Object {
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '\${testID}')) and ((JSONHas(labels, 'freq') = 1) and (toFloat64OrNull(JSONExtractString(labels, 'freq')) >= '4'))), sel_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 0 and 100000000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` asc,\`labels\` asc limit 1000) select * from sel_a order by \`labels\` asc,\`timestamp_ms\` asc",
  "stream": Array [],
}
`;

exports[`should transpile json requests 1`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'autem_quis')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'autem_quis')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "quidem sit",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
      Condition {
        "column": Raw {
          "raw": "isValidJSON(samples.string)",
        },
        "operator": "=",
        "value": Value {
          "value": 1,
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'autem_quis')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "JSONExtractString(labels, 'autem_quis')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": "quidem sit",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
    Array [
      Raw {
        "raw": "arrayFilter((x) -> x.2 != '', [('odit_iusto', if(JSONType(samples.string, 'dicta') == 'String', JSONExtractString(samples.string, 'dicta'), JSONExtractRaw(samples.string, 'dicta')))])",
      },
      "extra_labels",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'autem_quis')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'autem_quis')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "quidem sit",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile json requests 2`] = `
Array [
  Object {
    "labels": Object {
      "autem_quis": "quidem sit",
      "l1": "v3",
      "l2": "v2",
      "l3": "v4",
    },
    "string": "{\\"l1\\":\\"v3\\",\\"l3\\":\\"v4\\"}",
  },
]
`;

exports[`should transpile line format 1`] = `
Array [
  Object {
    "labels": Object {
      "int": 10,
      "lbl1": "a",
    },
    "string": "str a 5",
  },
]
`;

exports[`should transpile line format 2`] = `
Array [
  Object {
    "labels": Object {
      "entry": "str",
      "int": 10,
      "intval": "5",
      "lbl1": "a",
    },
    "string": "{ \\"entry\\": \\"str\\", \\"intval\\": 5 }",
  },
]
`;

exports[`should transpile line format 3`] = `
Array [
  Object {
    "labels": Object {
      "entry": "str",
      "int": 10,
      "intval": "5",
      "lbl1": "a",
    },
    "timestamp_ms": "0",
    "value": 5,
  },
  Object {
    "EOF": true,
  },
]
`;

exports[`should transpile log_stream_selector 1`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'et_dolorem')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'et_dolorem')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "nemo doloremque",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'quia')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'quia')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "eum voluptatem non eligendi",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'et_dolorem')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "JSONExtractString(labels, 'et_dolorem')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": "nemo doloremque",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'quia')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "JSONExtractString(labels, 'quia')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": "eum voluptatem non eligendi",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'et_dolorem')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'et_dolorem')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "nemo doloremque",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'quia')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'quia')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "eum voluptatem non eligendi",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 2`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'et_dolorem') = 1) and (JSONExtractString(labels, 'et_dolorem') = 'nemo doloremque')) and ((JSONHas(labels, 'quia') = 1) and (JSONExtractString(labels, 'quia') = 'eum voluptatem non eligendi'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile log_stream_selector 3`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                },
                                "operator": "!=",
                                "value": Value {
                                  "value": "[]",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'rerum_laborum')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                          },
                          "operator": "!=",
                          "value": Value {
                            "value": "[]",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'rerum_laborum')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": "[]",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 4`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'rerum_laborum') = 1) and (extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)') != '[]'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile log_stream_selector 5`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'et_dolorem')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'et_dolorem')",
                                },
                                "operator": "!=",
                                "value": Value {
                                  "value": "nemo doloremque",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'et_dolorem')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "JSONExtractString(labels, 'et_dolorem')",
                          },
                          "operator": "!=",
                          "value": Value {
                            "value": "nemo doloremque",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'et_dolorem')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'et_dolorem')",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": "nemo doloremque",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 6`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'et_dolorem') = 1) and (JSONExtractString(labels, 'et_dolorem') != 'nemo doloremque'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile log_stream_selector 7`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "[]",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'rerum_laborum')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": "[]",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'rerum_laborum')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "[]",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector 8`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'rerum_laborum') = 1) and (extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)') = '[]'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 1`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'et_dolorem')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'et_dolorem')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "nemo doloremque",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'quia')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'quia')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "eum voluptatem non eligendi",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
      Condition {
        "column": Raw {
          "raw": "position(string, 'at et')",
        },
        "operator": "!=",
        "value": Value {
          "value": 0,
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'et_dolorem')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "JSONExtractString(labels, 'et_dolorem')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": "nemo doloremque",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'quia')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "JSONExtractString(labels, 'quia')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": "eum voluptatem non eligendi",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'et_dolorem')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'et_dolorem')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "nemo doloremque",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'quia')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'quia')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "eum voluptatem non eligendi",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 2`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'et_dolorem') = 1) and (JSONExtractString(labels, 'et_dolorem') = 'nemo doloremque')) and ((JSONHas(labels, 'quia') = 1) and (JSONExtractString(labels, 'quia') = 'eum voluptatem non eligendi'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (position(string, 'at et') != 0) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 3`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                },
                                "operator": "!=",
                                "value": Value {
                                  "value": "[]",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
      Condition {
        "column": Raw {
          "raw": "position(string, 'consequatur nam soluta')",
        },
        "operator": "=",
        "value": Value {
          "value": 0,
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'rerum_laborum')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                          },
                          "operator": "!=",
                          "value": Value {
                            "value": "[]",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'rerum_laborum')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": "[]",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 4`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'rerum_laborum') = 1) and (extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)') != '[]'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (position(string, 'consequatur nam soluta') = 0) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 5`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'et_dolorem')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "JSONExtractString(labels, 'et_dolorem')",
                                },
                                "operator": "!=",
                                "value": Value {
                                  "value": "nemo doloremque",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
      Condition {
        "column": Raw {
          "raw": "extractAllGroups(string, '(^mol[eE][^ ]+e +voluptatibus)')",
        },
        "operator": "!=",
        "value": Raw {
          "raw": "[]",
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'et_dolorem')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "JSONExtractString(labels, 'et_dolorem')",
                          },
                          "operator": "!=",
                          "value": Value {
                            "value": "nemo doloremque",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'et_dolorem')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "JSONExtractString(labels, 'et_dolorem')",
                    },
                    "operator": "!=",
                    "value": Value {
                      "value": "nemo doloremque",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 6`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'et_dolorem') = 1) and (JSONExtractString(labels, 'et_dolorem') != 'nemo doloremque'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (extractAllGroups(string, '(^mol[eE][^ ]+e +voluptatibus)') != []) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile log_stream_selector with stream filter 7`] = `
Select {
  "aggregations": Array [],
  "conditions": Conjunction {
    "args": Array [
      Condition {
        "column": Raw {
          "raw": "",
          "toString": [Function],
        },
        "operator": undefined,
        "value": Value {
          "value": undefined,
        },
      },
      In {
        "column": Term {
          "term": "samples.fingerprint",
        },
        "operator": "in",
        "value": Select {
          "aggregations": Array [],
          "conditions": Conjunction {
            "args": Array [],
          },
          "ctx": Object {},
          "dist": false,
          "fmt": undefined,
          "having_conditions": Conjunction {
            "args": Array [],
          },
          "joins": Array [],
          "limitbycolumns": undefined,
          "limits": undefined,
          "order_expressions": Array [],
          "params": Object {},
          "preconditions": Conjunction {
            "args": Array [],
          },
          "request_totals": undefined,
          "sampling": undefined,
          "select_list": Array [
            "fingerprint",
          ],
          "tables": Array [
            Array [
              WithReference {
                "ref": With {
                  "alias": "str_sel",
                  "inline": undefined,
                  "query": Select {
                    "aggregations": Array [],
                    "conditions": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Conjunction {
                            "args": Array [
                              Condition {
                                "column": Raw {
                                  "raw": "JSONHas(labels, 'rerum_laborum')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": 1,
                                },
                              },
                              Condition {
                                "column": Raw {
                                  "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                                },
                                "operator": "=",
                                "value": Value {
                                  "value": "[]",
                                },
                              },
                            ],
                          },
                          "operator": undefined,
                          "value": Value {
                            "value": undefined,
                          },
                        },
                      ],
                    },
                    "ctx": Object {},
                    "dist": true,
                    "fmt": undefined,
                    "having_conditions": Conjunction {
                      "args": Array [],
                    },
                    "joins": Array [],
                    "limitbycolumns": undefined,
                    "limits": undefined,
                    "order_expressions": Array [],
                    "params": Object {},
                    "preconditions": Conjunction {
                      "args": Array [],
                    },
                    "request_totals": undefined,
                    "sampling": undefined,
                    "select_list": Array [
                      "fingerprint",
                      "labels",
                    ],
                    "tables": Array [
                      Array [
                        Parameter {
                          "name": "timeSeriesTable",
                          "value": "loki.time_series",
                        },
                      ],
                    ],
                    "withs": Object {},
                  },
                },
              },
            ],
          ],
          "withs": Object {},
        },
      },
      Condition {
        "column": Raw {
          "raw": "extractAllGroups(string, '(cons[eE][^ ]+r nam soluta)')",
        },
        "operator": "=",
        "value": Raw {
          "raw": "[]",
        },
      },
    ],
  },
  "ctx": Object {},
  "dist": false,
  "fmt": undefined,
  "having_conditions": Conjunction {
    "args": Array [],
  },
  "joins": Array [
    Object {
      "conditions": Array [
        Condition {
          "column": Term {
            "term": "samples.fingerprint",
          },
          "operator": "=",
          "value": Term {
            "term": "time_series.fingerprint",
          },
        },
      ],
      "table": Array [
        WithReference {
          "ref": With {
            "alias": "str_sel",
            "inline": undefined,
            "query": Select {
              "aggregations": Array [],
              "conditions": Conjunction {
                "args": Array [
                  Condition {
                    "column": Conjunction {
                      "args": Array [
                        Condition {
                          "column": Raw {
                            "raw": "JSONHas(labels, 'rerum_laborum')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": 1,
                          },
                        },
                        Condition {
                          "column": Raw {
                            "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                          },
                          "operator": "=",
                          "value": Value {
                            "value": "[]",
                          },
                        },
                      ],
                    },
                    "operator": undefined,
                    "value": Value {
                      "value": undefined,
                    },
                  },
                ],
              },
              "ctx": Object {},
              "dist": true,
              "fmt": undefined,
              "having_conditions": Conjunction {
                "args": Array [],
              },
              "joins": Array [],
              "limitbycolumns": undefined,
              "limits": undefined,
              "order_expressions": Array [],
              "params": Object {},
              "preconditions": Conjunction {
                "args": Array [],
              },
              "request_totals": undefined,
              "sampling": undefined,
              "select_list": Array [
                "fingerprint",
                "labels",
              ],
              "tables": Array [
                Array [
                  Parameter {
                    "name": "timeSeriesTable",
                    "value": "loki.time_series",
                  },
                ],
              ],
              "withs": Object {},
            },
          },
        },
        "time_series",
      ],
      "type": "left",
    },
  ],
  "limitbycolumns": undefined,
  "limits": Object {
    "number": Parameter {
      "name": "limit",
      "value": 3,
    },
    "offset": undefined,
  },
  "order_expressions": Array [
    Array [
      "timestamp_ms",
      "desc",
    ],
    Array [
      "labels",
      "desc",
    ],
  ],
  "params": Object {
    "from": Parameter {
      "name": "from",
      "value": 1,
    },
    "limit": Parameter {
      "name": "limit",
      "value": 3,
    },
    "samplesTable": Parameter {
      "name": "samplesTable",
      "value": "loki.samples_read",
    },
    "timeSeriesTable": Parameter {
      "name": "timeSeriesTable",
      "value": "loki.time_series",
    },
    "to": Parameter {
      "name": "to",
      "value": 2,
    },
  },
  "preconditions": Conjunction {
    "args": Array [],
  },
  "request_totals": undefined,
  "sampling": undefined,
  "select_list": Array [
    Array [
      "time_series.labels",
      "labels",
    ],
    Array [
      "samples.string",
      "string",
    ],
    Array [
      "samples.fingerprint",
      "fingerprint",
    ],
    Array [
      "samples.timestamp_ms",
      "timestamp_ms",
    ],
  ],
  "tables": Array [
    Array [
      Parameter {
        "name": "samplesTable",
        "value": "loki.samples_read",
      },
      Term {
        "term": "samples",
      },
    ],
  ],
  "withs": Object {
    "str_sel": With {
      "alias": "str_sel",
      "inline": undefined,
      "query": Select {
        "aggregations": Array [],
        "conditions": Conjunction {
          "args": Array [
            Condition {
              "column": Conjunction {
                "args": Array [
                  Condition {
                    "column": Raw {
                      "raw": "JSONHas(labels, 'rerum_laborum')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": 1,
                    },
                  },
                  Condition {
                    "column": Raw {
                      "raw": "extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)')",
                    },
                    "operator": "=",
                    "value": Value {
                      "value": "[]",
                    },
                  },
                ],
              },
              "operator": undefined,
              "value": Value {
                "value": undefined,
              },
            },
          ],
        },
        "ctx": Object {},
        "dist": true,
        "fmt": undefined,
        "having_conditions": Conjunction {
          "args": Array [],
        },
        "joins": Array [],
        "limitbycolumns": undefined,
        "limits": undefined,
        "order_expressions": Array [],
        "params": Object {},
        "preconditions": Conjunction {
          "args": Array [],
        },
        "request_totals": undefined,
        "sampling": undefined,
        "select_list": Array [
          "fingerprint",
          "labels",
        ],
        "tables": Array [
          Array [
            Parameter {
              "name": "timeSeriesTable",
              "value": "loki.time_series",
            },
          ],
        ],
        "withs": Object {},
      },
    },
  },
}
`;

exports[`should transpile log_stream_selector with stream filter 8`] = `"WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'rerum_laborum') = 1) and (extractAllGroups(JSONExtractString(labels, 'rerum_laborum'), '(^con.+q.at[a-z]r)') = '[]'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1 and 2) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (extractAllGroups(string, '(cons[eE][^ ]+r nam soluta)') = []) order by \`timestamp_ms\` desc,\`labels\` desc limit 3"`;

exports[`should transpile logfmt requests 1`] = `
Array [
  Object {
    "labels": Object {
      "autem_quis": "quidem sit",
      "l1": "v3",
      "l2": "v2",
      "l3": "v4",
    },
    "string": "l1=\\"v3\\" l3=\\"v4\\" ",
  },
]
`;

exports[`should transpile new style 1 1`] = `
Object {
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7387779420506657'))), sel_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ms\` desc",
  "stream": Array [],
}
`;

exports[`should transpile new style 2 1`] = `
Object {
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.2119268970232')) and ((JSONHas(labels, 'freq') = 1) and (JSONExtractString(labels, 'freq') = '2'))), sel_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (extractAllGroups(string, '(2[0-9]$)') != []) order by \`timestamp_ms\` desc,\`labels\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ms\` desc",
  "stream": Array [],
}
`;

exports[`should transpile new style 3 1`] = `
Object {
  "duration": 1000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7026038163617259')) and ((JSONHas(labels, 'freq') = 1) and (JSONExtractString(labels, 'freq') = '2'))), rate_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (extractAllGroups(string, '(2[0-9]$)') != []) order by \`timestamp_ms\` desc,\`labels\` desc), rate_b AS (select JSONExtractKeysAndValues(labels, 'String') as \`labels\`,floor(timestamp_ms / 1000) * 1000 as \`timestamp_ms\`,toFloat64(count(1)) * 1000 / 1000 as \`value\` from rate_a group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select \`labels\`,floor(timestamp_ms / 2000) * 2000 as \`timestamp_ms\`,argMin(rate_b.value, rate_b.timestamp_ms) as \`value\` from \`rate_b\` group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc",
  "stream": Array [],
}
`;

exports[`should transpile new style 4 1`] = `
Object {
  "duration": 1000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7026038163617259')) and ((JSONHas(labels, 'freq') = 1) and (JSONExtractString(labels, 'freq') = '2'))), rate_a AS (select \`labels\`,toUInt64(intDiv(timestamp_ms, 1000) * 1000) as \`timestamp_ms\`,toFloat64(0) as \`value\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (extractAllGroups(string, '(2[0-9]$)') != []) group by \`labels\`,\`timestamp_ms\` order by \`labels\` asc,\`timestamp_ms\` asc) select \`labels\`,\`timestamp_ms\`,min(value) as \`value\` from (select * from rate_a as \`rate_a\` UNION ALL select \`a1\`.\`labels\`,number * 1000 + 1638802620000 as \`timestamp_ms\`,toFloat64(1) as \`value\` from (select \`labels\` from str_sel) as \`a1\`,numbers(600) as \`a2\`) group by \`labels\`,\`timestamp_ms\` order by \`labels\`,\`timestamp_ms\`",
  "stream": Array [],
}
`;

exports[`should transpile new style 5 1`] = `
Object {
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.000341166036469831_json'))), sel_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ms\` desc",
  "stream": Array [
    [Function],
  ],
}
`;

exports[`should transpile new style 6 1`] = `
Object {
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.2053747382122484_json'))), sel_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\`,arrayFilter((x) -> x.2 != '', [('lbl_repl', if(JSONType(samples.string, 'new_lbl') == 'String', JSONExtractString(samples.string, 'new_lbl'), JSONExtractRaw(samples.string, 'new_lbl')))]) as \`extra_labels\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (isValidJSON(samples.string) = 1) and ((indexOf(extra_labels, ('lbl_repl', 'new_val')) > 0) or ((arrayExists(x -> x.1 == 'lbl_repl', extra_labels) = 0) and ((JSONHas(labels, 'lbl_repl') = 1) and (JSONExtractString(labels, 'lbl_repl') = 'new_val')))) order by \`timestamp_ms\` desc,\`labels\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ms\` desc",
  "stream": Array [],
}
`;

exports[`should transpile new style 7 1`] = `
Object {
  "duration": 3000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.1547558751138609_json'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc",
  "stream": Array [
    [Function],
    [Function],
    [Function],
    [Function],
    [Function],
  ],
}
`;

exports[`should transpile new style 8 1`] = `
Object {
  "duration": 1000,
  "matrix": true,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.4075242197275857'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc",
  "stream": Array [
    [Function],
    [Function],
    [Function],
    [Function],
    [Function],
  ],
}
`;

exports[`should transpile new style 9 1`] = `
Object {
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.7186063017626447_json'))), sel_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\`,arrayFilter((x) -> x.2 != '', [('sid', if(JSONType(samples.string, 'str_id') == 'String', JSONExtractString(samples.string, 'str_id'), JSONExtractRaw(samples.string, 'str_id')))]) as \`extra_labels\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) and (isValidJSON(samples.string) = 1) and ((arrayExists(x -> x.1 == 'sid' AND (coalesce(toFloat64OrNull(x.2) >= '598', 0)), extra_labels) != 0) or ((arrayExists(x -> x.1 == 'sid', extra_labels) = 0) and ((JSONHas(labels, 'sid') = 1) and (toFloat64OrNull(JSONExtractString(labels, 'sid')) >= '598')))) order by \`timestamp_ms\` desc,\`labels\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ms\` desc",
  "stream": Array [],
}
`;

exports[`should transpile new style 10 1`] = `
Object {
  "duration": 1000,
  "matrix": false,
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '0.5505504081219323'))), sel_a AS (select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\`,arrayFilter(x -> x.1 != '' AND x.2 != '', arrayZip(['e'], arrayMap(x -> x[length(x)], extractAllGroupsHorizontal(string, '^([^0-9]+)[0-9]+$')))) as \`extra_labels\` from loki.samples_read as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\`   between 1638802620000 and 1638803220000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` desc,\`labels\` desc limit 2000) select * from sel_a order by \`labels\` desc,\`timestamp_ms\` desc",
  "stream": Array [],
}
`;

exports[`should transpile plugins 1`] = `
Array [
  Object {
    "labels": Object {
      "lbl1": "a",
    },
    "timestamp_ms": "0",
    "value": 10,
  },
  Object {
    "EOF": true,
  },
]
`;

exports[`should transpile series 1`] = `"select DISTINCT \`fingerprint\`,\`labels\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (JSONExtractString(labels, 'test_id') = '123'))"`;

exports[`should transpile tail 1`] = `
Object {
  "query": "WITH str_sel AS (select DISTINCT \`fingerprint\`,\`labels\` from loki.time_series where ((JSONHas(labels, 'test_id') = 1) and (extractAllGroups(JSONExtractString(labels, 'test_id'), '(_ws)') != '[]'))) select \`time_series\`.\`labels\` as \`labels\`,\`samples\`.\`string\` as \`string\`,\`samples\`.\`fingerprint\` as \`fingerprint\`,\`samples\`.\`timestamp_ms\` as \`timestamp_ms\` from loki.samples_v2 as \`samples\` left join str_sel as time_series on \`samples\`.\`fingerprint\` = \`time_series\`.\`fingerprint\` where (\`samples\`.\`timestamp_ms\` > (toUnixTimestamp(now()) - 5) * 1000) and (\`samples\`.\`fingerprint\` in (select \`fingerprint\` from str_sel)) order by \`timestamp_ms\` asc",
  "stream": Array [],
}
`;
