networks:
  qryn-e2e:
    driver: bridge
services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    hostname: clickhouse
    networks:
      - qryn-e2e
    healthcheck:
      test: "wget --no-verbose --tries=1 --spider http://localhost:8123/?query=SELECT%201 || exit 1"
      interval: 5s
      timeout: 5s
      retries: 5

  qryn:
    image: node:22-alpine
    networks:
      - qryn-e2e
    volumes:
      - ../../:/qryn
    depends_on:
      - clickhouse
    working_dir: /qryn
    environment:
      CLICKHOUSE_SERVER: clickhouse
      CLICKHOUSE_DB: qryn
    ports:
      - 3100:3100
    command:
      - sh
      - -c
      - "sleep 5 && npm install && nodejs qryn.mjs"
    healthcheck:
      test: "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"
      interval: 5s
      timeout: 5s
      retries: 5

  otel-collector:
    image: ghcr.io/metrico/qryn-otel-collector:0.0.11
    depends_on:
      - clickhouse
      - qryn
    networks:
      - qryn-e2e
    volumes:
      - ./otel-collector.yaml:/etc/otel/config.yaml
